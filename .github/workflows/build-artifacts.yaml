name: Build Artifacts
jobs:
  build:
    name: Build and Upload Artifacts
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Read version
        id: get_version
        run: |
          echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r test/requirements.txt
      # Only check packaging files on Ubuntu
      - name: Ensure packaging files are present (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          test -f packaging/snapcraft.yaml
          test -f packaging/spiderfoot.spec
          test -f packaging/spiderfoot.rb
          test -f packaging/debian/control
      - name: Build source distribution
        run: |
          python setup.py sdist
      - name: Build wheel
        run: |
          python -m pip install build
          python -m build --wheel
      # Only sign and hash artifacts on Ubuntu
      - name: Hash and sign artifacts (Ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sha256sum dist/* > dist/SHA256SUMS.txt
          gpg --batch --yes --armor --detach-sign --output dist/SHA256SUMS.txt.asc --sign dist/SHA256SUMS.txt || true
      - name: Check built distributions with twine
        run: |
          python -m pip install twine
          twine check dist/*
      - name: Check built wheel/sdist with pip check
        run: |
          python -m pip install dist/*.whl || true
          pip check || true
      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spiderfoot-${{ matrix.os }}-${{ matrix.python-version }}-${{ steps.get_version.outputs.version }}-dist
          path: dist/*
      - name: Upload sdist as artifact
        uses: actions/upload-artifact@v4
        with:
          name: spiderfoot-${{ matrix.os }}-${{ matrix.python-version }}-${{ steps.get_version.outputs.version }}-sdist
          path: dist/*.tar.gz
      - name: Upload wheel as artifact
        uses: actions/upload-artifact@v4
        with:
          name: spiderfoot-${{ matrix.os }}-${{ matrix.python-version }}-${{ steps.get_version.outputs.version }}-wheel
          path: dist/*.whl
      # Build .deb package (Kali/Ubuntu, Python 3.9 only)
      - name: Build .deb package (Kali/Ubuntu, Python 3.9 only)
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper python3-all python3-setuptools
          cp -r packaging/debian .
          dpkg-buildpackage -us -uc -b
      - name: Upload .deb package
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        uses: actions/upload-artifact@v4
        with:
          name: spiderfoot-${{ steps.get_version.outputs.version }}-deb
          path: ../*.deb
      # Build RPM package (Fedora/CentOS/RHEL, Python 3.9 only)
      - name: Build RPM package (Fedora/CentOS/RHEL, Python 3.9 only)
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm python3-all python3-setuptools
          cp packaging/spiderfoot.spec .
          python3 setup.py bdist_rpm --spec-file spiderfoot.spec || echo "RPM build may require additional spec file customization."
      - name: Upload RPM package
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        uses: actions/upload-artifact@v4
        with:
          name: spiderfoot-${{ steps.get_version.outputs.version }}-rpm
          path: dist/*.rpm
      # Generate Homebrew formula
      - name: Generate Homebrew formula
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        run: |
          cp packaging/spiderfoot.rb .
      - name: Upload Homebrew formula
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        uses: actions/upload-artifact@v4
        with:
          name: spiderfoot-${{ steps.get_version.outputs.version }}-homebrew-formula
          path: spiderfoot.rb
      # Build Snap package (Snapcraft, Python 3.9 only)
      - name: Build Snap package (Snapcraft, Python 3.9 only)
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        run: |
          sudo apt-get update
          sudo apt-get install -y snapcraft
          cp packaging/snapcraft.yaml .
          snapcraft pack || echo "Snapcraft build may require snapcraft.yaml customization."
      - name: Upload Snap package
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        uses: actions/upload-artifact@v4
        with:
          name: spiderfoot-${{ steps.get_version.outputs.version }}-snap
          path: *.snap
      # Validate .deb package
      - name: Validate .deb package
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        run: |
          sudo apt-get install -y lintian
          lintian ../*.deb || (echo 'lintian found issues in .deb package' && exit 1)
          dpkg -c ../*.deb
          dpkg -i ../*.deb || true
          spiderfoot --help || true
      # Validate RPM package
      - name: Validate RPM package
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        run: |
          sudo apt-get install -y rpm
          rpm -qpl dist/*.rpm
          rpm -ivh --test dist/*.rpm || true
      # Validate Snap package
      - name: Validate Snap package
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        run: |
          sudo apt-get install -y snapd
          snap install --dangerous *.snap || true
          snap run spiderfoot || true
      # Validate Homebrew formula
      - name: Validate Homebrew formula
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        run: |
          brew install --formula ./spiderfoot.rb || true
          brew test spiderfoot || true
      # Generate changelog (git-cliff)
      - name: Generate changelog (git-cliff)
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        run: |
          sudo apt-get update && sudo apt-get install -y git-cliff
          git-cliff --tag v${{ steps.get_version.outputs.version }} -o packaging/CHANGELOG.md
      # Generate SBOM (syft)
      - name: Generate SBOM (syft)
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b .
          ./syft . -o cyclonedx-json > packaging/SBOM-cyclonedx.json
          ./syft . -o cyclonedx-xml > packaging/SBOM-cyclonedx.xml
          ./syft . -o spdx-json > packaging/SBOM-spdx.json
          ./syft . -o spdx > packaging/SBOM-spdx.txt
          ./syft . -o syft-json > packaging/SBOM-syft.json
      # Security scan (trivy)
      - name: Security scan (trivy)
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.9'
        run: |
          sudo apt-get install -y wget
          wget -qO- https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.2_Linux-64bit.tar.gz | tar xz
          ./trivy fs --exit-code 1 --severity HIGH,CRITICAL --scanners vuln,secret,config .
